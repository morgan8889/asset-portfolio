---
description: Create a pull request with project-specific validation and spec integration
---

## User Input

```text
$ARGUMENTS
```

## Command Overview

Create a pull request with project-specific validation and integration with the speckit workflow. This command:

1. Detects feature branches (e.g., `001-csv-import`) and links to spec files
2. Runs project validations (type-check, lint, tests)
3. Generates PR descriptions with constitution compliance checklist
4. Handles both feature branches and regular branches with appropriate templates

## Execution Steps

### 1. Check Current State

First, gather information about the current git state:

```bash
# Get current branch
CURRENT_BRANCH=$(git branch --show-current)

# Get git status
git status --short

# Get all changes (staged and unstaged)
git diff HEAD
```

### 2. Detect Feature Branch Pattern

Check if the current branch follows the speckit pattern (`[number]-[feature-name]`):

```bash
# Check if branch matches pattern: 001-feature-name
if [[ "$CURRENT_BRANCH" =~ ^([0-9]+)-(.+)$ ]]; then
  FEATURE_NUM="${BASH_REMATCH[1]}"
  FEATURE_NAME="${BASH_REMATCH[2]}"
  SPEC_DIR="specs/${FEATURE_NUM}-${FEATURE_NAME}"

  echo "ðŸ“‹ Feature branch detected: $FEATURE_NUM-$FEATURE_NAME"

  # Check if spec directory exists
  if [ -d "$SPEC_DIR" ]; then
    echo "âœ… Spec directory found: $SPEC_DIR"
    IS_FEATURE_BRANCH=true
    SPEC_FILE="$SPEC_DIR/spec.md"
    TASKS_FILE="$SPEC_DIR/tasks.md"
  else
    echo "âš ï¸  Spec directory not found (expected: $SPEC_DIR)"
    IS_FEATURE_BRANCH=false
  fi
else
  echo "â„¹ï¸  Regular branch (not speckit feature)"
  IS_FEATURE_BRANCH=false
fi
```

### 3. Run Project Validations

Run the project's validation suite to ensure code quality:

```bash
echo "ðŸ” Running project validations..."

# Type checking
echo "  â†’ Type checking..."
npm run type-check
TYPE_CHECK_EXIT=$?

# Linting
echo "  â†’ Linting..."
npm run lint
LINT_EXIT=$?

# Unit tests
echo "  â†’ Running tests..."
npm run test:run
TEST_EXIT=$?

# Check results
if [ $TYPE_CHECK_EXIT -ne 0 ] || [ $LINT_EXIT -ne 0 ] || [ $TEST_EXIT -ne 0 ]; then
  echo ""
  echo "âš ï¸  Validation Failures Detected:"
  [ $TYPE_CHECK_EXIT -ne 0 ] && echo "  âŒ Type checking failed (exit code: $TYPE_CHECK_EXIT)"
  [ $LINT_EXIT -ne 0 ] && echo "  âŒ Linting failed (exit code: $LINT_EXIT)"
  [ $TEST_EXIT -ne 0 ] && echo "  âŒ Tests failed (exit code: $TEST_EXIT)"
  echo ""
  echo "Do you want to proceed with creating the PR anyway? (yes/no)"

  # Wait for user response
  # If user says no, exit with error
  # If user says yes, continue with warning
else
  echo "âœ… All validations passed!"
fi
```

**Important**: If validations fail, ask the user if they want to proceed. Use the `AskUserQuestion` tool if needed.

### 4. Create Branch if on Main

If currently on the `main` branch, create a feature branch first:

```bash
if [ "$CURRENT_BRANCH" = "main" ]; then
  echo "âš ï¸  Cannot create PR from main branch"
  echo "Creating a new feature branch..."

  # Generate branch name from changes or prompt user
  # Example: feature/description-from-commit

  BRANCH_NAME="feature/update-from-main"
  git checkout -b "$BRANCH_NAME"
  echo "âœ… Created and switched to branch: $BRANCH_NAME"
fi
```

### 5. Stage and Commit Changes

Stage all modified files and create a commit:

```bash
# Get list of modified files
MODIFIED_FILES=$(git status --short | grep '^ M' | awk '{print $2}')
UNTRACKED_FILES=$(git status --short | grep '^??' | awk '{print $2}')

# Stage modified files
if [ -n "$MODIFIED_FILES" ]; then
  echo "ðŸ“ Staging modified files..."
  git add $MODIFIED_FILES
fi

# Stage new files (ask user first if there are untracked files)
if [ -n "$UNTRACKED_FILES" ]; then
  echo "ðŸ“„ Untracked files found:"
  echo "$UNTRACKED_FILES"
  # Consider asking user which files to stage
fi

# Generate commit message
echo "ðŸ’¬ Generating commit message..."

# Get recent commit style for reference
git log --format=%B -n 5 > /tmp/recent_commits.txt

# Analyze changes
COMMIT_SUMMARY=$(git diff --cached --stat | head -1)

# Load spec summary if feature branch
if [ "$IS_FEATURE_BRANCH" = true ] && [ -f "$SPEC_FILE" ]; then
  SPEC_SUMMARY=$(grep -A 5 "^## Feature Summary" "$SPEC_FILE" | tail -n +2 | head -3)
fi

# Create commit with appropriate message
# Format: feat|fix|docs|style|refactor|test|chore: description
# Include Co-Authored-By attribution

git commit -m "$(cat <<EOF
feat: [generated from analysis]

[Detailed description based on git diff and spec file]

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
```

**Note**: The actual commit message should be generated by analyzing the `git diff HEAD` output and extracting meaningful changes. For feature branches, incorporate the spec.md summary if available.

### 6. Generate PR Description

Create a PR description based on branch type:

#### For Feature Branches (001-feature-name):

```markdown
## Summary

[Brief description from spec.md Feature Summary section, or generated from git diff analysis]

**Related Spec**: [specs/$FEATURE_NUM-$FEATURE_NAME/spec.md](specs/$FEATURE_NUM-$FEATURE_NAME/spec.md)
**Related Tasks**: [specs/$FEATURE_NUM-$FEATURE_NAME/tasks.md](specs/$FEATURE_NUM-$FEATURE_NAME/tasks.md)

### Changes in this PR

[Generate bullet points from git diff --stat and git log analysis]
- Updated [component/file] to [description]
- Added [new feature/functionality]
- Fixed [issue/bug]

## Test Plan

- [ ] Type checking passes (`npm run type-check`)
- [ ] Linting passes (`npm run lint`)
- [ ] Unit tests pass (`npm run test:run`)
- [ ] E2E tests pass (`npm run test:e2e`) [if applicable]
- [ ] Manually tested in browser
- [ ] Verified against spec requirements

## Constitution Compliance

- [ ] **Privacy-First**: No data sent to server (all data in IndexedDB)
- [ ] **Financial Precision**: Uses Decimal.js for monetary calculations
- [ ] **Type Safety**: TypeScript strict mode, no type assertions without validation

## Additional Notes

[Any warnings from validations, known issues, or follow-up work needed]

---
ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
```

#### For Regular Branches (feature/*, fix/*):

```markdown
## Summary

[Brief description generated from git diff analysis and commit messages]

### Changes in this PR

[Generate bullet points from git diff analysis]
- [List of changes]

## Test Plan

- [ ] Type checking passes (`npm run type-check`)
- [ ] Linting passes (`npm run lint`)
- [ ] Unit tests pass (`npm run test:run`)
- [ ] Manually tested in browser

## Notes

[Any warnings from validations or additional context]

---
ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
```

### 7. Push and Create PR

Push the branch and create the pull request:

```bash
# Push branch to remote
echo "â¬†ï¸  Pushing branch to origin..."
git push -u origin "$CURRENT_BRANCH"

# Create PR with gh CLI
echo "ðŸš€ Creating pull request..."

# Extract title from commit message or spec
PR_TITLE="[Generated title from commit or spec]"

# Save PR body to temp file
PR_BODY_FILE=$(mktemp)
cat > "$PR_BODY_FILE" <<'EOF'
[Generated PR description from above]
EOF

# Create PR
gh pr create --title "$PR_TITLE" --body-file "$PR_BODY_FILE"

# Get PR URL
PR_URL=$(gh pr view --json url -q .url)

echo "âœ… Pull request created: $PR_URL"

# Cleanup
rm "$PR_BODY_FILE"
```

## Guidelines

### Commit Message Generation

- Analyze `git diff HEAD` to understand changes
- Use conventional commit format: `type(scope): description`
- Types: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`
- Keep first line under 72 characters
- Include detailed body explaining the "why" not just the "what"
- Always include `Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>`

### PR Title Generation

- For feature branches: Extract from spec.md "Feature Summary" heading
- For regular branches: Use first line of commit message
- Keep concise (< 72 characters)
- Use present tense ("Add feature" not "Added feature")

### Spec File Parsing

When reading spec.md for feature branches:

```bash
# Extract feature summary (first paragraph after ## Feature Summary)
SPEC_SUMMARY=$(awk '/^## Feature Summary/{flag=1; next} /^##/{flag=0} flag' "$SPEC_FILE" | head -5)

# Extract user scenarios if needed
USER_SCENARIOS=$(awk '/^## User Scenarios/{flag=1; next} /^##/{flag=0} flag' "$SPEC_FILE")
```

### Error Handling

- If `git push` fails: Check for remote tracking branch, suggest `git push --set-upstream origin $BRANCH`
- If `gh pr create` fails: Check if PR already exists, verify gh CLI authentication
- If validation fails: Present clear options to user (proceed or abort)
- If no changes staged: Error with message "No changes to commit"

## Best Practices

1. **Always run validations first** - Catch issues before creating PR
2. **Read spec files carefully** - Extract meaningful context for PR descriptions
3. **Generate descriptive commit messages** - Future readers should understand changes
4. **Include constitution compliance** - Remind reviewers of project principles
5. **Link to related files** - Make it easy to navigate to spec/tasks
6. **Be transparent about failures** - If validations failed, note it in PR body

## Example Flow

**Feature Branch Example** (user on `012-tax-features-stock`):

1. âœ… Detected feature branch `012-tax-features-stock`
2. âœ… Found spec at `specs/012-tax-features-stock/spec.md`
3. âœ… Type check passed
4. âœ… Lint passed
5. âœ… Tests passed
6. ðŸ“ Generated commit: `feat(tax): add ESPP/RSU tracking with capital gains analysis`
7. â¬†ï¸  Pushed to `origin/012-tax-features-stock`
8. ðŸš€ Created PR: "Tax-Aware Portfolio Tracking (ESPP/RSU)"
   - Linked to spec.md and tasks.md
   - Included constitution checklist
   - Listed all changes from git diff
9. âœ… PR URL: https://github.com/user/asset-portfolio/pull/123

**Regular Branch Example** (user on `fix/dashboard-scrollbar`):

1. â„¹ï¸  Regular branch detected
2. âœ… Type check passed
3. âœ… Lint passed
4. âœ… Tests passed
5. ðŸ“ Generated commit: `fix(ui): remove horizontal scrollbar from dashboard`
6. â¬†ï¸  Pushed to `origin/fix/dashboard-scrollbar`
7. ðŸš€ Created PR: "Fix: Remove horizontal scrollbar from dashboard"
   - Standard test plan
   - No spec links (not a feature branch)
8. âœ… PR URL: https://github.com/user/asset-portfolio/pull/124
