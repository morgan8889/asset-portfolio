# Implementation Plan: Portfolio Export Functionality

**Branch**: `011-export-functionality` | **Date**: 2026-01-30 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-export-functionality/spec.md`

## Summary

Implement client-side export functionality for portfolio data, enabling users to download PDF performance reports, CSV transaction histories, and CSV holdings snapshots. All operations run entirely in the browser to maintain privacy-first architecture. Uses html2canvas + jsPDF for PDF generation and PapaParse (already installed) for CSV generation.

## Technical Context

**Language/Version**: TypeScript 5.3 with Next.js 14.2 (App Router)
**Primary Dependencies**: React 18, jsPDF + html2canvas (PDF), PapaParse (CSV), Recharts 2.15, decimal.js, date-fns
**Storage**: Browser IndexedDB via Dexie.js (read-only for export)
**Testing**: Vitest for unit tests, Playwright for E2E tests
**Target Platform**: Modern browsers (Chrome, Firefox, Safari, Edge)
**Project Type**: Web application (Next.js)
**Performance Goals**: PDF generation < 3s, CSV 5K rows < 1s
**Constraints**: 100% client-side processing (no server requests), offline-capable
**Scale/Scope**: Standard portfolios (up to 10K transactions, 100 holdings)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Pre-Design Verification

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Privacy-First (NON-NEGOTIABLE) | ✅ PASS | All export operations client-side only; no data sent to server; PDF/CSV generated in browser |
| II. Financial Precision | ✅ PASS | All monetary values formatted from Decimal.js; no floating-point in exports |
| III. Type Safety & Validation | ✅ PASS | Zod schemas defined in data-model.md for ReportConfig; TypeScript strict mode |
| IV. Test-Driven Quality | ✅ PASS | Unit tests for export service; E2E tests for export workflows defined |
| V. Component Architecture | ✅ PASS | Uses shadcn/ui; Server Components where possible; Client Components for interactive export buttons |

### Post-Design Verification

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Privacy-First | ✅ VERIFIED | research.md confirms jsPDF/html2canvas/PapaParse all run locally; Blob API for downloads |
| II. Financial Precision | ✅ VERIFIED | data-model.md specifies Decimal.toFixed() for all monetary formatting |
| III. Type Safety | ✅ VERIFIED | contracts/export-service.ts provides complete TypeScript interfaces |
| IV. Test-Driven Quality | ✅ VERIFIED | quickstart.md includes test commands and verification steps |
| V. Component Architecture | ✅ VERIFIED | Lazy loading for PDF libs; existing shadcn/ui components used |

### Technology Stack Compliance

| New Dependency | Justification | Constitution Note |
|----------------|---------------|-------------------|
| jsPDF | Client-side PDF generation per FR-002 | Addition documented |
| html2canvas | DOM capture for chart export to PDF | Required by jsPDF approach |
| jspdf-autotable | Crisp table rendering in PDF | Plugin for jsPDF |

No violations requiring justification.

## Project Structure

### Documentation (this feature)

```text
specs/011-export-functionality/
├── plan.md              # This file
├── research.md          # Technology decisions (PDF/CSV libraries)
├── data-model.md        # Export types and data structures
├── quickstart.md        # Implementation guide
├── contracts/
│   └── export-service.ts # TypeScript service interface
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── types/
│   └── export.ts              # Export type definitions
├── lib/
│   ├── services/
│   │   ├── export-service.ts  # Main export service
│   │   └── __tests__/
│   │       └── export-service.test.ts
│   └── stores/
│       └── export.ts          # Export progress state
├── components/
│   └── reports/
│       ├── performance-report.tsx    # PDF-capturable view
│       ├── export-button.tsx         # Reusable export button
│       └── date-range-select.tsx     # Date range dropdown
└── app/
    └── (dashboard)/
        └── reports/
            └── page.tsx       # Updated with export handlers

tests/
└── e2e/
    └── export-reports.spec.ts # E2E test for exports
```

**Structure Decision**: Extends existing Next.js App Router structure. Export service follows existing pattern in `src/lib/services/`. New types added to `src/types/`. Components added to existing `src/components/` hierarchy.

## Complexity Tracking

No constitution violations to justify. Feature uses:
- Standard service pattern (matches existing services)
- Standard Zustand store (matches existing stores)
- Standard component patterns (shadcn/ui + Client Components for interactivity)
- Lazy loading for bundle optimization (established pattern)

## Generated Artifacts

| Artifact | Status | Description |
|----------|--------|-------------|
| research.md | ✅ Complete | PDF library comparison (html2canvas + jsPDF chosen), CSV library confirmation (PapaParse) |
| data-model.md | ✅ Complete | ReportConfig, ExportProgress, TransactionExportRow, HoldingExportRow, PerformanceReportData |
| contracts/export-service.ts | ✅ Complete | IExportService interface, utility functions, column definitions |
| quickstart.md | ✅ Complete | Implementation order, code patterns, testing commands |
